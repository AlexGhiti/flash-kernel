#!/bin/sh

# Copyright (C) 2006  Joey Hess  <joeyh@debian.org>
# Copyright (C) 2006, 2007, 2008, 2009, 2010, 2011  Martin Michlmayr <tbm@cyrius.com>
# Copyright (C) 2011  Lo√Øc Minier <lool@dooz.org>
# Copyright (C) 2011  Julian Andres Klode <jak@debian.org>

# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301,
# USA.

set -e

self="$(basename "$0")"

PROC_CPUINFO="/proc/cpuinfo"
PROC_MTD="/proc/mtd"

# somewhat RFC2822 based, but case sensitive, not tolerant to spaces etc.
MACHINE_DB="
Machine: Buffalo Linkstation LiveV3 (LS-CHL)
Kernel-Flavors: orion5x
Machine-Id: 2913
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage.buffalo
Boot-Initrd-Path: /boot/initrd.buffalo

Machine: Buffalo Linkstation Mini
Kernel-Flavors: orion5x
Machine-Id: 1858
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage.buffalo
Boot-Initrd-Path: /boot/initrd.buffalo

Machine: Buffalo Linkstation Pro/Live
Kernel-Flavors: orion5x
Machine-Id: 1585
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage.buffalo
Boot-Initrd-Path: /boot/initrd.buffalo

Machine: Buffalo/Revogear Kurobox Pro
Kernel-Flavors: orion5x
Machine-Id: 1509
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage.buffalo
Boot-Initrd-Path: /boot/initrd.buffalo

Machine: D-Link DNS-323
Kernel-Flavors: orion5x
Machine-Id: 1542
Mtd-Kernel: Linux Kernel
Mtd-Initrd: File System
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x00800000

Machine: Genesi Efika Smartbook
Kernel-Flavors: mx5
U-Boot-Kernel-Address: 0x90008000
U-Boot-Initrd-Address: 0x0
U-Boot-Script-Address: 0x0
U-Boot-Script-Template: bootscr.mx5
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd
Boot-Script-Path: /boot/boot.scr
Extra-Cmdline: root=/dev/sda2

Machine: Genesi EfikaMX nettop
Kernel-Flavors: mx5
U-Boot-Kernel-Address: 0x90008000
U-Boot-Initrd-Address: 0x0
U-Boot-Script-Address: 0x0
U-Boot-Script-Template: bootscr.mx5
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd
Boot-Script-Path: /boot/boot.scr
Extra-Cmdline: root=/dev/sda2

Machine: GLAN Tank
Method: symlink
Kernel-Flavors: iop32x
Machine-Id: 1100

Machine: GTA02
Method: multi
Kernel-Flavors: s3c24xx
U-Boot-Multi-Address: 0x30008000
Boot-Multi-Path: /boot/uImage.bin

Machine: HP Media Vault mv2120
Kernel-Flavors: orion5x
Machine-Id: 1693
U-Boot-Multi-Address: 0x01600000
Boot-Multi-Path: /boot/uImage

Machine: HP t5325 Thin Client
Kernel-Flavors: kirkwood
Machine-Id: 2846
U-Boot-Multi-Address: 0x01600000
Boot-Multi-Path: /boot/uImage

# Really: Intel SS4000-e and compatibles
Machine: Lanner EM7210
Method: redboot
Kernel-Flavors: iop32x
Machine-Id: 1212
Mtd-Kernel: zImage
Mtd-Initrd: ramdisk.gz

Machine: Linksys NSLU2
Method: slug
Kernel-Flavors: ixp4xx
Mtd-Kernel: Kernel
Mtd-Initrd: Ramdisk

Machine: Marvell DB-78x00-BP Development Board
U-Boot-Kernel-Address: 0x2000000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: Marvell GuruPlug Reference Board
Kernel-Flavors: kirkwood
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: Marvell OpenRD Base Board
Kernel-Flavors: kirkwood
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: Marvell OpenRD Client Board
Kernel-Flavors: kirkwood
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: Marvell OpenRD Ultimate Board
Kernel-Flavors: kirkwood
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: Marvell SheevaPlug Reference Board
Kernel-Flavors: kirkwood
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: Marvell eSATA SheevaPlug Reference Board
Kernel-Flavors: kirkwood
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: QNAP TS-109/TS-209
Kernel-Flavors: orion5x
Machine-Id: 1565
Mtd-Kernel: Kernel
Mtd-Initrd: RootFS1
U-Boot-Kernel-Address: 0x00008000

Machine: QNAP TS-119/TS-219
Kernel-Flavors: kirkwood
Machine-Id: 2139
Mtd-Kernel: Kernel
Mtd-Initrd: RootFS1
U-Boot-Kernel-Address: 0x00008000

Machine: QNAP TS-409
Kernel-Flavors: orion5x
Machine-Id: 1601
Mtd-Kernel: Kernel
Mtd-Initrd: RootFS1
U-Boot-Kernel-Address: 0x00008000

Machine: QNAP TS-41x
Kernel-Flavors: kirkwood
Machine-Id: 2502
Mtd-Kernel: Kernel
Mtd-Initrd: RootFS1
U-Boot-Kernel-Address: 0x00008000

Machine: Seagate FreeAgent DockStar
Kernel-Flavors: kirkwood
U-Boot-Kernel-Address: 0x00008000
U-Boot-Initrd-Address: 0x0
Boot-Kernel-Path: /boot/uImage
Boot-Initrd-Path: /boot/uInitrd

Machine: Thecus N2100
Method: redboot
Kernel-Flavors: iop32x
Machine-Id: 1101
Mtd-Kernel: kernel
Mtd-Initrd: ramdisk

Machine: Toshiba AC100 / Dynabook AZ
Method: android
Android-Boot-Device: /dev/mmcblk0p2
Android-Boot-Config: /boot/bootimg.cfg
"

FK_DIR="/usr/share/flash-kernel"

. "${FK_CHECKOUT:-$FK_DIR}/functions"

if [ -z "$TEST_FLASH_KERNEL" ]; then
	main "$@"
fi
